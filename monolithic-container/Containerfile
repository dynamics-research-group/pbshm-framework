# Python version, e.g. 3.11, 3.13
ARG PYTHON_VERSION=3.13

FROM python:${PYTHON_VERSION}-slim-bookworm

# PBSHM Framework Version
ARG PBSHM_FRAMEWORK_VERSION=0.7.1

# User setup - Define default UID/GID for non-root container user
ARG USER=appuser
ARG GROUP=appuser
ARG UID=10001
ARG GID=10001

# Install MongoDB, Caddy, and supervisor, create directories in one layer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gnupg \
    curl \
    ca-certificates \
    supervisor \
    debian-keyring \
    debian-archive-keyring \
    apt-transport-https && \
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg && \
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list && \
    curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor && \
    echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/8.0 main" | tee /etc/apt/sources.list.d/mongodb-org-8.0.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends mongodb-org caddy && \
    mkdir -p /data/db /var/log/mongodb /app /etc/caddy && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Setup non-root user with configurable UID/GID and set permissions
RUN groupadd --gid ${GID} ${GROUP} && \
    useradd --uid ${UID} --gid ${GROUP} --create-home --shell /bin/bash ${USER} && \
    chown -R ${USER}:${GROUP} /data/db /var/log/mongodb /app

# Switch to non-root user for application installation
USER ${USER}

# Environment variables for paths and configuration
ENV PATH=$PATH:/home/$USER/.local/bin \
    MONGO_AUTH_DB=admin \
    MONGO_DATA_DB=pbshm \
    MONGO_USER_COLLECTION=users \
    MONGO_DEFAULT_COLLECTION=structures \
    USER_EMAIL=user@pbshm.ac.uk \
    USER_PASSWORD=secure_password \
    USER_FIRST_NAME=Admin \
    USER_SECOND_NAME=User

# Install pbshm-framework and dependencies from PyPI
RUN pip install --no-cache-dir --user pbshm-framework==${PBSHM_FRAMEWORK_VERSION} gunicorn

# Switch to user and copy application files
USER ${USER}
COPY --chown=${USER}:${GROUP} --chmod=755 ./flask-startup.sh /app/flask-startup.sh
COPY --chown=${USER}:${GROUP} --chmod=644 ./supervisord.conf /etc/supervisord.conf
COPY --chown=${USER}:${GROUP} --chmod=644 ./Caddyfile /etc/caddy/Caddyfile

# Run the application with supervisor (all processes run as appuser)
ENTRYPOINT ["/usr/bin/supervisord"]
